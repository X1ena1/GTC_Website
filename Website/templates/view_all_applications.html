<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Rebate Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}"> 
    <link rel="stylesheet" href="{{ url_for('static', filename='css/report_styles.css') }}"> 
    <style>
        .search-container { margin-bottom: 20px; display: flex; gap: 10px; }
        #quickSearch { 
            padding: 10px; width: 100%; max-width: 400px; 
            background: #d9f2d2; border: 1px solid #d9f2d2b9; color: rgb(0, 0, 0); border-radius: 5px;
        }
        .disburse-form { display: flex; flex-direction: column; gap: 5px; }
        .disburse-input { padding: 4px; border-radius: 4px; border: 1px solid #ccc; font-size: 12px; width: 100px; }
        .disburse-btn { background: #2ecc71; color: white; border: none; padding: 4px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .disburse-btn:hover { background: #27ae60; }
    </style>
</head>
<body>
    
    <header class="main-header">
        <div class="top-bar">
            <div class="logo-area">
                <img src="{{ url_for('static', filename='img/uh-logo.png') }}" alt="UH Logo">
            </div>
            <h2 class="welcome-title">
                {% if session.get('sponsor_name') %}
                    {{ session.get('sponsor_name') }} Portal
                {% else %}
                    Administrative Control Panel
                {% endif %}
            </h2>
            <div class="header-nav-container">
                <div class="nav-links-right">
                    <a href="{{ url_for('index') }}">Home</a>

                    <div class="dropdown" style="margin: 0 10px;">
                        <button class="dropbtn">Search Audits</button>
                        <div class="dropdown-content">
                            <a href="{{ url_for('aging_report') }}">Aging Audit</a>
                            <a href="{{ url_for('high_value_audit') }}">High-Value Audit</a>
                        </div>
                    </div>

                    <div class="dropdown">
                        <button class="dropbtn">Admin & Reports</button>
                        <div class="dropdown-content">
                            <a href="{{ url_for('energy_report') }}">Energy Report</a>
                            <a href="{{ url_for('payment_report') }}">Payment Report</a>
                            <a href="{{ url_for('sponsor_approvals') }}">Sponsor Approvals</a>
                        </div>
                    </div>
                    <a href="{{ url_for('logout') }}" class="logout-link">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main class="dark-report-page"> 
        <section class="report-container">
            
            <div class="report-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div>
                    <h2>Application Reports</h2>
                    <p class="section-description">Real-time oversight of all energy incentive data.</p>
                </div>
                
                <form method="GET" action="{{ url_for('view_all_applications') }}" class="filter-form" style="display: flex; gap: 10px; align-items: center;">
                    <label for="status_filter">Status:</label>
                    <select name="status_filter" id="status_filter" onchange="this.form.submit()" style="padding: 8px; background: #ffffff; color: rgb(0, 0, 0); border-radius: 5px;">
                        <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All Records</option>
                        <option value="pending" {% if current_filter == 'pending' %}selected{% endif %}>Pending Review</option>
                        <option value="disbursed" {% if current_filter == 'disbursed' %}selected{% endif %}>Fully Paid</option>
                        <option value="pending_disbursement" {% if current_filter == 'pending_disbursement' %}selected{% endif %}>Approved/Unpaid</option>
                        <option value="rejected" {% if current_filter == 'rejected' %}selected{% endif %}>Rejected / Denied</option>
                    </select>
                </form>
            </div>

            <div class="search-container">
                <input type="text" id="quickSearch" placeholder="Quick Search by SOP #, Building, or Category..." onkeyup="filterTable()">
            </div>

            <div class="report-summary-bar" style="display: flex; gap: 20px; margin-bottom: 25px;">
                <div style="background:#d9f2d2; padding: 20px; border-radius: 8px; border-left: 5px solid #3498db; flex: 1;">
                    <p style="color: #1d1d1d; margin: 0; font-size: 11px; text-transform: uppercase;">Total Load</p>
                    <h3 id="totalCountDisplay" style="color: #000000; margin: 5px 0;">{{ total_count }} Applications</h3>
                </div>
                <div style="background: #d9f2d2; padding: 20px; border-radius: 8px; border-left: 5px solid #2ecc71; flex: 1;">
                    <p style="color: #1d1d1d; margin: 0; font-size: 11px; text-transform: uppercase;">Committed Capital</p>
                    <h3 id="totalCapitalDisplay" style="color: #040404; margin: 5px 0;">${{ "{:,.2f}".format(total_committed) }}</h3>
                </div>
            </div>

            <div class="table-container">
                <table class="reports-table" id="rebateTable">
                    <thead>
                        <tr>
                            <th>SOP #</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Building</th>
                            <th>Amount</th>
                            <th>Dates (Sub/Pay)</th>
                            <th>Action Center</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for app in applications %} 
                        <tr>
                            <td style="font-weight: bold; color: #3498db;">{{ app.SOP_Number }}</td>
                            <td>{{ app.Category }}</td>
                            <td>
                                <span class="status-{{ app.Status | lower | replace(' ', '-') }}">
                                    {{ app.Status }}
                                </span>
                            </td>
                            <td>{{ app.Building }}</td>
                            <td>${{ "{:,.2f}".format(app.Approved_Amount or 0) }}</td>
                            <td>
                                <small>Sub: {{ app.Submission_Date }}</small><br>
                                <small>Pay: {{ app.Payment_Date or 'Pending' }}</small>
                            </td>
                            <td>
                                {% if session.get('sponsor_logged_in') and app.Status == 'Approved' and not app.Payment_Date %}
                                    <form action="{{ url_for('disburse_payment', sop_number=app.SOP_Number) }}" method="POST" class="disburse-form">
                                        <input type="number" step="0.01" name="approved_amount" placeholder="Amount" class="disburse-input" required>
                                        <button type="submit" class="disburse-btn">Disburse Funds</button>
                                    </form>
                                {% else %}
                                    <a href="{{ url_for('review_application', application_id=app.SOP_Number) }}" class="action-small-btn" style="text-decoration: none; background: #444; padding: 5px 10px; border-radius: 4px; color: white;">
                                        Manage
                                    </a>
                                {% endif %}
                                </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
    function filterTable() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("quickSearch");
        filter = input.value.toUpperCase();
        table = document.getElementById("rebateTable");
        tr = table.getElementsByTagName("tr");

        // Running counters for dynamic update
        let visibleCount = 0;
        let visibleTotalAmount = 0;

        for (i = 1; i < tr.length; i++) {
            tr[i].style.display = "none";
            td = tr[i].getElementsByTagName("td");
            
            let rowMatches = false;
            for (var j = 0; j < td.length; j++) {
                if (td[j]) {
                    txtValue = td[j].textContent || td[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        rowMatches = true;
                        break;
                    }
                }
            }

            if (rowMatches) {
                tr[i].style.display = "";
                visibleCount++;
                
                // Get amount from 5th column (index 4), clean symbols, and add to total
                let amountText = td[4].textContent.replace(/[$,]/g, '');
                let amountValue = parseFloat(amountText) || 0;
                visibleTotalAmount += amountValue;
            }
        }

        // Update the summary boxes in the UI
        document.getElementById("totalCountDisplay").innerText = visibleCount + " Applications";
        document.getElementById("totalCapitalDisplay").innerText = "$" + visibleTotalAmount.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    </script>
</body>
</html>